# 백엔드 아키텍처 가이드

## 아키텍처 개요

Platform 백엔드는 Monorepo 구조로 시작하여 MSA(Microservice Architecture)로 전환 가능하도록 설계되었습니다.

### 현재 아키텍처: Monorepo
```
┌─────────────────────────────────────┐
│           app-core                  │
│  ┌─────────────────────────────┐   │
│  │        Common Layer         │   │
│  │  (config, dto, exception)   │   │
│  └─────────────────────────────┘   │
│  ┌─────────────────────────────┐   │
│  │       Domain Layer          │   │
│  │  (schedule, user, board)    │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
              ↓
         [MariaDB]
```

### 목표 아키텍처: MSA
```
    [API Gateway]
         ↓
    ┌────┴────┬────────┬────────┐
    ↓         ↓        ↓        ↓
[app-core] [app-auth] [app-chat] [app-notification]
    ↓         ↓        ↓        ↓
[MariaDB] [MariaDB] [Redis]  [MongoDB]
```

## 기술 스택

### Core Technologies
- **Framework**: Spring Boot 3.3.2
- **Language**: Java 17
- **Build Tool**: Gradle 8.5
- **Database**: MariaDB 10.11
- **ORM**: MyBatis 3.0.3

### Supporting Technologies
- **API Documentation**: SpringDoc OpenAPI 3 (Swagger)
- **Security**: Spring Security + JWT
- **Database Migration**: Flyway
- **Container**: Docker & Docker Compose
- **Logging**: Logback

## 프로젝트 구조

### 패키지 구조
```
kr.co.platform.core/
├── CoreApplication.java           # 메인 애플리케이션 진입점
├── common/                        # 공통 컴포넌트 (내장)
│   ├── config/                   # 공통 설정
│   │   └── SpringDocConfig.java
│   ├── dto/                      # 공통 DTO
│   │   ├── BaseDto.java
│   │   └── CommonResponse.java
│   ├── entity/                   # Base Entity
│   │   └── BaseEntity.java
│   ├── exception/                # 예외 처리
│   │   ├── BusinessException.java
│   │   ├── ErrorCode.java
│   │   └── GlobalExceptionHandler.java
│   └── util/                     # 유틸리티
│       ├── DateUtil.java
│       └── StringUtil.java
├── config/                       # 애플리케이션 설정
│   ├── SecurityConfig.java      # Spring Security 설정
│   ├── SwaggerConfig.java       # Swagger UI 설정
│   └── WebConfig.java           # Web MVC 설정
└── domain/                       # 비즈니스 도메인
    └── schedule/                 # 일정 관리 도메인 (예시)
        ├── mapper/               # MyBatis Mapper
        │   ├── ScheduleMapper.java
        │   └── ScheduleMapper.xml
        ├── model/                # 모델 클래스
        │   ├── dto/
        │   │   ├── ScheduleRequestDto.java
        │   │   ├── ScheduleResponseDto.java
        │   │   └── ScheduleSearchDto.java
        │   ├── entity/
        │   │   └── ScheduleEntity.java
        │   └── enums/
        │       └── ScheduleType.java
        ├── service/              # 비즈니스 로직
        │   ├── ScheduleService.java
        │   └── impl/
        │       └── ScheduleServiceImpl.java
        └── web/                  # REST Controller
            └── ScheduleController.java
```

## 레이어드 아키텍처

### 1. Presentation Layer (Web)
- **역할**: HTTP 요청/응답 처리, 입력 검증
- **구성요소**: 
  - REST Controllers
  - Request/Response DTOs
  - Swagger 문서화
- **패키지**: `domain.*.web`

### 2. Business Layer (Service)
- **역할**: 비즈니스 로직 구현, 트랜잭션 관리
- **구성요소**:
  - Service Interfaces
  - Service Implementations
  - Business Rules
- **패키지**: `domain.*.service`

### 3. Persistence Layer (Mapper)
- **역할**: 데이터베이스 접근, SQL 실행
- **구성요소**:
  - MyBatis Mapper Interfaces
  - Mapper XML Files
  - Entity Classes
- **패키지**: `domain.*.mapper`

### 4. Common Layer
- **역할**: 공통 기능 제공
- **구성요소**:
  - Base Classes (BaseEntity, BaseDto)
  - Exception Handling
  - Utilities
  - Common Configurations
- **패키지**: `common.*`

## 도메인 주도 설계 (DDD)

### 도메인 구조
각 도메인은 독립적인 패키지로 구성되며, 다음과 같은 구조를 갖습니다:

```
domain/
└── [domain-name]/
    ├── mapper/          # 데이터 접근
    ├── model/           # 도메인 모델
    │   ├── dto/        # 데이터 전송 객체
    │   ├── entity/     # 엔티티
    │   └── enums/      # 열거형
    ├── service/         # 비즈니스 로직
    │   └── impl/       # 구현체
    └── web/            # REST API
```

### 도메인 간 통신
- **동기 통신**: REST API를 통한 HTTP 통신
- **비동기 통신**: 이벤트 기반 (향후 Kafka/Redis 도입 예정)

## API 설계 원칙

### RESTful API 규칙
```
GET    /api/v1/schedules      # 목록 조회
GET    /api/v1/schedules/{id} # 단건 조회
POST   /api/v1/schedules      # 생성
PUT    /api/v1/schedules/{id} # 수정
DELETE /api/v1/schedules/{id} # 삭제
```

### 응답 형식
```java
@Data
public class CommonResponse<T> {
    private final String status;      // SUCCESS, ERROR
    private final String message;     // 응답 메시지
    private final T data;            // 실제 데이터
    private final LocalDateTime timestamp;
}
```

### 에러 응답
```json
{
    "status": "ERROR",
    "message": "요청 처리 중 오류가 발생했습니다",
    "data": {
        "errorCode": "SCHEDULE_NOT_FOUND",
        "errorMessage": "일정을 찾을 수 없습니다"
    },
    "timestamp": "2025-08-08T10:30:00"
}
```

## 데이터베이스 설계

### MyBatis 설정
```yaml
mybatis:
  mapper-locations: classpath:kr/co/platform/**/*.xml
  type-aliases-package: kr.co.platform.core.**.entity
  configuration:
    map-underscore-to-camel-case: true
    use-generated-keys: true
```

### Entity 기본 구조
```java
@Data
public abstract class BaseEntity {
    private Long id;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private String createdBy;
    private String updatedBy;
    private Boolean isDeleted;
}
```

### Mapper XML 예시
```xml
<mapper namespace="kr.co.platform.core.domain.schedule.mapper.ScheduleMapper">
    <select id="findById" resultType="ScheduleEntity">
        SELECT * FROM schedule 
        WHERE id = #{id} 
        AND is_deleted = false
    </select>
</mapper>
```

## 보안 아키텍처

### 현재 상태
- Spring Security 통합
- 개발 환경에서 임시 비활성화
- JWT 토큰 기반 인증 준비

### 목표 구조
```
Client → [JWT Token] → API Gateway → [Validated Token] → Microservice
```

### JWT 구조
```json
{
    "sub": "user123",
    "name": "홍길동",
    "authorities": ["ROLE_USER", "ROLE_ADMIN"],
    "exp": 1234567890
}
```

## 트랜잭션 관리

### 선언적 트랜잭션
```java
@Service
@Transactional(readOnly = true)
public class ScheduleServiceImpl {
    
    @Transactional
    public void createSchedule(ScheduleRequestDto dto) {
        // 트랜잭션 내에서 실행
    }
}
```

### 트랜잭션 전파 레벨
- **REQUIRED** (기본값): 트랜잭션이 있으면 참여, 없으면 생성
- **REQUIRES_NEW**: 항상 새로운 트랜잭션 생성
- **SUPPORTS**: 트랜잭션이 있으면 참여, 없어도 실행

## 예외 처리 전략

### 예외 계층 구조
```
Exception
└── RuntimeException
    └── BusinessException
        ├── EntityNotFoundException
        ├── DuplicateKeyException
        └── ValidationException
```

### Global Exception Handler
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<CommonResponse<Void>> handleBusinessException(
            BusinessException e) {
        return ResponseEntity.badRequest()
            .body(CommonResponse.error(e.getMessage()));
    }
}
```

## 로깅 전략

### 로그 레벨
- **ERROR**: 시스템 오류, 즉시 조치 필요
- **WARN**: 잠재적 문제, 모니터링 필요
- **INFO**: 중요 비즈니스 이벤트
- **DEBUG**: 개발/디버깅 정보

### 로깅 설정
```yaml
logging:
  level:
    kr.co.platform: DEBUG
    org.springframework: INFO
    org.mybatis: DEBUG
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
```

## 성능 최적화

### 데이터베이스 최적화
- Connection Pool 설정 (HikariCP)
- MyBatis 캐시 활용
- 인덱스 최적화
- N+1 문제 방지

### API 최적화
- 페이징 처리
- 응답 데이터 최소화
- 캐싱 전략 (향후 Redis 도입)

## 모니터링 및 메트릭

### Health Check
```
GET /api/v1/actuator/health
```

### 메트릭 수집
- JVM 메모리 사용량
- HTTP 요청 통계
- 데이터베이스 연결 풀 상태
- 비즈니스 메트릭

## 배포 전략

### 현재: 단일 JAR 배포
```bash
java -jar app-core-0.0.1-SNAPSHOT.jar
```

### 향후: 컨테이너 기반 배포
```dockerfile
FROM openjdk:17-jdk-slim
COPY build/libs/*.jar app.jar
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

## 마이그레이션 전략

### Monorepo → MSA 전환 계획
1. **Phase 1**: 도메인 경계 명확화
2. **Phase 2**: 공통 모듈 라이브러리화
3. **Phase 3**: 도메인별 서비스 분리
4. **Phase 4**: API Gateway 도입
5. **Phase 5**: 서비스 메시 구축

### MyBatis → JPA 전환 계획
1. 엔티티 클래스 JPA 어노테이션 추가
2. Repository 인터페이스 도입
3. 점진적 Mapper → Repository 전환
4. QueryDSL 도입 검토

## 베스트 프랙티스

### 코드 작성 원칙
1. **명확한 네이밍**: 약어 사용 금지
2. **단일 책임 원칙**: 하나의 클래스는 하나의 역할
3. **의존성 주입**: 생성자 주입 선호
4. **불변 객체**: 가능한 final 사용

### 테스트 전략
```java
@SpringBootTest
@AutoConfigureMockMvc
class ScheduleControllerTest {
    
    @Test
    void 일정_조회_성공() {
        // given
        // when
        // then
    }
}
```

## 참고 자료

- [Spring Boot Reference](https://docs.spring.io/spring-boot/docs/current/reference/)
- [MyBatis Documentation](https://mybatis.org/mybatis-3/)
- [Domain-Driven Design](https://martinfowler.com/tags/domain%20driven%20design.html)
- [Microservices Patterns](https://microservices.io/patterns/)